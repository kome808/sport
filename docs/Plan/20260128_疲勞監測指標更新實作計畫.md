# 疲勞監測指標更新實作計畫

根據規格書 [`26260128 ANTIGRAVITY 系統開發規格書：疲勞監測參數與警示邏輯.md`](file:///d:/程式開發/運動管理平台/docs/Plan/26260128%20ANTIGRAVITY%20系統開發規格書：疲勞監測參數與警示邏輯.md) 更新系統四項指標的計算邏輯、閾值判斷與 UI 說明。

---

## 一、變更總覽

| 指標 | 主要變更 |
|------|----------|
| **ACWR (急慢性負荷比)** | 新增紫燈等級 (≥ 2.0)、低負荷 (< 0.8) 改為黃燈、調整閾值邊界 |
| **RHR (晨間心跳)** | 基準線從 14 天改為 7 天、閾值從 5/10/15 改為 5/10 |
| **Wellness (身心狀態)** | **改為 10 分制滑桿介面**、引入 Z-score 計算 (與過去 28 天比較) |
| **sRPE (今日訓練負荷)** | 改為「週負荷變化率」警示邏輯 |

---

## 二、需修改的檔案清單

### 2.1 後端 SQL 計算邏輯 (高優先)

| 檔案 | 位置 | 修改內容 |
|------|------|----------|
| [015_fatigue_monitoring_rpcs.sql](file:///d:/程式開發/運動管理平台/supabase/migrations/015_fatigue_monitoring_rpcs.sql) | 第 66-77 行 | ACWR 風險等級判斷：新增紫燈 (≥ 2.0)、低負荷 (< 0.8) 改為黃燈 |
| 同上 | 第 148-203 行 | RHR 基準線計算：從 14 天改為 7 天、閾值調整 |
| 同上 | 第 319-335 行 | Wellness 改為 Z-score 計算；sRPE 改為週變化率警示 |

> [!IMPORTANT]
> 後端 SQL 是計算核心，必須優先修改。建立新的遷移檔案 `031_update_fatigue_thresholds.sql`，避免直接修改原始 015 檔案。

---

### 2.2 前端圖表閾值區間線 (圖表視覺化)

#### [ACWRTrendChart.tsx](file:///d:/程式開發/運動管理平台/frontend/src/components/fatigue/charts/ACWRTrendChart.tsx)

| 行數 | 目前內容 | 規格書定義 | 修改內容 |
|------|----------|------------|----------|
| 75-78 | `value: 1.5, legend: 'H 高風險 (1.5)'` | 紅燈 1.5-1.99、紫燈 ≥ 2.0 | 新增 `value: 2.0` 紫燈線 |
| 82-86 | `value: 1.3, legend: 'W 預警 (1.3)'` | 黃燈 1.31-1.49 | ✅ 保留（邊界一致）|
| 89-93 | `value: 0.8, legend: 'S 安全 (0.8)'` | < 0.8 為低負荷黃燈 | 標籤改為「低負荷 (0.8)」|

---

#### [TrendChart.tsx](file:///d:/程式開發/運動管理平台/frontend/src/components/fatigue/TrendChart.tsx)

| 行數 | 目前內容 | 修改內容 |
|------|----------|----------|
| 118 | `const y = yScale(600);` sRPE 600 分界線 | 移除或改為週變化率相關視覺提示 |
| 131-133 | `High Risk (600)` 標籤 | 移除固定閾值線（改由後端週變化率判斷）|
| 182 | `colors={({ data }) => data.sRPE >= 600 ? '#EF4444' : '#3B82F6'}` | 移除 600 閾值顏色判斷 |

---

### 2.3 教練端 Dashboard 指標說明與警示

#### [FatigueDashboard.tsx](file:///d:/程式開發/運動管理平台/frontend/src/components/fatigue/FatigueDashboard.tsx)

| 行數 | 目前內容 | 規格書定義 | 修改內容 |
|------|----------|------------|----------|
| 113-118 | RHR 進度條刻度 `-5bpm, +5bpm, +10bpm` | 綠 ≤4、黃 5-9、紅 ≥10 | 改為 `+4bpm, +9bpm, +10bpm` |
| 146 | Wellness `/25` 顯示 | 滿分 50 或使用 Z-score | 根據規格書確認後調整 |
| 195-200 | sRPE 進度條刻度 `0 AU, 400, 800 AU+` | 改為週變化率 | 移除固定 AU 刻度，改為變化率說明 |
| 240-246 | ACWR 進度條刻度 `0.5, 1.3, 1.5+` | 新增 2.0 紫燈 | 增加 `2.0` 刻度 |

---

#### [DashboardPage.tsx](file:///d:/程式開發/運動管理平台/frontend/src/pages/dashboard/DashboardPage.tsx)

| 行數 | 目前內容 | 規格書定義 | 修改內容 |
|------|----------|------------|----------|
| 436 | `ACWR > 1.5` | 紅燈 1.5-1.99、紫燈 ≥ 2.0 | 新增紫燈說明 |
| 443 | `sRPE (AU) > 600` | 週變化率 > 15% | 改為「週負荷變化率 > 15%」|
| 450 | `Wellness 總分 < 12` | Z-score < -2 | 改為「Z-score < -2 (低於個人 28 天均值 2 個標準差)」|
| 457 | `Δ > 8` (RHR) | Δ ≥ 10 | 改為 `Δ ≥ 10 bpm` |

---

### 2.4 教練端/球員端共用指標說明 Dialog

#### [MetricDetailDialog.tsx](file:///d:/程式開發/運動管理平台/frontend/src/components/fatigue/MetricDetailDialog.tsx)

| 行數 | 指標 | 目前內容 | 規格書定義 | 修改內容 |
|------|------|----------|------------|----------|
| 31-36 | ACWR | `0.80-1.30` 綠、`1.31-1.50` 黃、`> 1.5` 紅、`< 0.80` 綠 | 0.80-1.30 綠、1.31-1.49 黃、1.50-1.99 紅、≥ 2.0 紫、< 0.80 黃 | 新增紫燈、低負荷改黃燈 |
| 55 | RHR 計算說明 | `過去 14 天平均基準` | 過去 **7 天**移動平均 | 改為「7 天」|
| 56-60 | RHR 閾值 | `< 5` 綠、`5-10` 黃、`> 10` 紅 | ≤ 4 綠、5-9 黃、≥ 10 紅 | 調整邊界值 |
| 69-73 | Wellness | 總分閾值 (`< 15` 紅) | Z-score < -2 紅 | 改為 Z-score 邏輯 |
| 81-85 | sRPE | `< 400` 綠、`400-600` 黃、`> 600` 紅 | 週變化率 < 10% 綠、10-15% 黃、> 15% 紅 | 改為週變化率說明 |

---

### 2.5 球員端頁面

#### [PlayerReportPage.tsx](file:///d:/程式開發/運動管理平台/frontend/src/pages/player/PlayerReportPage.tsx)

| 行數 | 目前內容 | 修改內容 |
|------|----------|----------|
| 676-681 | Wellness 滑桿 `min="1" max="5"` | 改為 `min="1" max="10"`，並加入顏色漸層背景 |
| 682-685 | 滑桿刻度說明 `很差/很好` | 更新為 10 分制說明，可考慮加入中間刻度 |
| 695-697 | Wellness 說明區塊 `1分/5分` | 改為 `1分 (非常差)/10分 (非常好)` |

> **介面設計重點**：使用顏色漸層條 (紅色→黃色→綠色) 讓選手直覺感受分數意義。

> 球員端使用 `MetricDetailDialog` 元件，修改該元件後球員端會自動更新。

---

### 2.6 歷史記錄圖表

#### [WellnessChart.tsx](file:///d:/程式開發/運動管理平台/frontend/src/components/records/WellnessChart.tsx)

| 行數 | 目前內容 | 修改內容 |
|------|----------|----------|
| 85 | `max: chartMode === 'wellness' ? 25 : 'auto'` | 若 Wellness 改為滿分 50，需調整為 50 |
| 151 | `Wellness 總分範圍 5-25` | 若改為 50 分制，需更新說明 |

---

## 三、實作優先順序與檢查清單

### Phase 1: 後端邏輯 (高優先)
- [ ] 建立 `supabase/migrations/031_update_fatigue_thresholds.sql`
  - [ ] 更新 `calculate_ewma_acwr` 函數：新增紫燈、低負荷改黃燈
  - [ ] 更新 `calculate_rhr_baseline` 函數：14 天改 7 天、閾值調整
  - [ ] 新增 `calculate_wellness_zscore` 函數：Z-score 計算
  - [ ] 新增 `calculate_weekly_load_change` 函數：週負荷變化率

### Phase 2: 前端圖表閾值線 (中優先)
- [ ] `ACWRTrendChart.tsx`：新增 2.0 紫燈線、修改 0.8 標籤
- [ ] `TrendChart.tsx`：移除 600 閾值線

### Phase 3: 前端指標說明 (中優先)
- [ ] `MetricDetailDialog.tsx`：更新四項指標區間說明
- [ ] `FatigueDashboard.tsx`：更新進度條刻度
- [ ] `DashboardPage.tsx`：更新警示文字說明

### Phase 4: 驗證與測試
- [ ] 執行遷移腳本
- [ ] 驗證 Dashboard 風險名單顯示正確
- [ ] 驗證球員端 `MetricDetailDialog` 顯示更新後的說明
- [ ] 驗證圖表閾值線正確顯示

---

## 四、已確認設計決策

### ✅ Wellness 分制與介面設計
- **採用 10 分制**：5 題 × 10 分 = 滿分 **50 分**
- **介面設計**：使用「滑桿 (Sliding Scale) + 顏色漸層條」，而非 10 個文字選項
  - 選手直覺拖曳到符合感覺的位置
  - 後台紀錄 1-10 數值
  - 既保留數據敏感度，又優化使用者體驗

### ✅ 四項指標高風險判斷邏輯

| 指標 | 條件 | 說明 |
|------|------|------|
| **ACWR** | > 1.5 (高風險)、> 2.0 (極高風險) | 極高風險時受傷機率是平時 5-7 倍 |
| **ACWR 低負荷** | < 0.8 | 標示為「訓練不足風險」，體能流失導致未來受傷機率上升 |
| **RHR** | +5 bpm (高風險)、+10 bpm (嚴重風險) | 比過去 7 天平均高出的 bpm |
| **Wellness** | Z-score < -2 | 低於個人 28 天平均 2 個標準差 |
| **週負荷變化率** | > 15% 或單週增加 > 1000 AU | 本週 vs 上週總負荷比較 |

### ✅ Z-score Fallback 機制
- **不足 28 天時**：使用「比個人過去 4 週平均分數下降 20% 以上」作為替代算法
- **不足 7 天時**：暫不顯示 Wellness 警示，以灰色標示「資料不足」

---

## 五、驗證計畫

### 自動化測試
- 執行現有 Playwright 測試確認 UI 未破壞
- 新增 SQL 單元測試驗證閾值判斷邏輯

### 手動驗證
1. 開啟 Dashboard，確認風險名單顯示正確
2. 點擊任一指標卡片，確認 `MetricDetailDialog` 區間說明正確
3. 查看 ACWR 趨勢圖，確認 0.8、1.3、1.5、2.0 四條閾值線正確顯示
4. 查看 sRPE 趨勢圖，確認 600 閾值線已移除
5. 球員端點擊「指標說明」按鈕，確認說明已更新
