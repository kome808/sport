# 球隊邀請機制實作計畫 (Phase 1.11)

> 日期：2026-01-13
> 主題：球隊邀請機制 (Team Invitation System)

## 1. 目標
简代球員加入流程，同時修復球員登入的安全性問題（改用 RPC 封裝，避免開放匿名讀取權限）。

## 2. 核心流程

1.  **教練端**：
    - 設定「球隊通行碼」與分享連結。
2.  **學生端**：
    - **加入**：輸入通行碼 -> 呼叫 `join_team` RPC (建立/認領) -> 自動登入。
    - **登入**：輸入代碼/密碼 -> 呼叫 `login_player` RPC -> 取得 Token (Session)。

## 3. 架構修正 (Security Check)

> [!IMPORTANT]
> **安全性修正**
> 經檢視，目前的 RLS 政策若設為 `authenticated`，會導致尚未登入的球員無法讀取 `players` 表來驗證密碼。
> 若設為 `public`，則會暴露所有球員個資。
> **解決方案**：
> 1. `players` 表維持僅限 `authenticated` (教練) 讀取。
> 2. 球員登入與註冊改為透過 **SECURITY DEFINER RPC** 執行，不直接開放 Table 權限。

## 4. 變更內容

### 資料庫 (Database)
#### [NEW] `014_team_invitation_and_security.sql`
- **Schema 變更**:
    - `teams`: Add `invitation_code`, `is_invitation_enabled`.
- **RPC Functions**:
    - `login_player(code, password)`: 驗證代碼與密碼，回傳球員資料。
    - `join_team(invitation_code, ...)`: 驗證通行碼並建立/更新球員。
    - `validate_invitation_code(code)`: 驗證通行碼並回傳球隊基本資料。

### 前端 (Frontend)
#### [MODIFY] `usePlayer.ts`
- 修改 `usePlayerLogin`：改為呼叫 `rpc('login_player')`，不再直接 Query Table。

#### [MODIFY] `useTeam.ts`
- 新增 `updateTeamInvitation` mutation。


#### [NEW] `InvitationPage.tsx` (`/invite/:teamSlug`)
- 使用 `validate_invitation_code` RPC 驗證代碼。
- 使用 `join_team` RPC 提交資料。


#### [MODIFY] `TeamSettingsPage.tsx`
- 新增「邀請設定」區塊。

## 5. 驗證計畫

### 安全性驗證
1.  **匿名存取測試**：
    - 使用無痕視窗，嘗試直接 `supabase.from('players').select('*')`，確認被 RLS 擋下 (回傳空或 Error)。
    - 嘗試呼叫 `login_player` RPC，確認輸入正確密碼可取得資料。


### 手動驗證
1.  **教練設定**：
    - 進入球隊設定，設定通行碼為 `8888`。
    - 複製連結。
2.  **學生註冊 (新增)**：
    - 無痕視窗開啟連結 -> 輸入 `8888`。
    - 點擊「我是新球員」-> 輸入姓名「王小明」、背號 `99`、密碼 `0000`。
    - 送出 -> 應轉導至 `/p/王小明頁面`。
    - 檢查資料庫 `players` 表，確認資料已建立且密碼已更新。
3.  **學生註冊 (認領)**：
    - 教練先建好「李大同」。
    - 學生開啟連結 -> 輸入 `8888`。
    - 列表看到「李大同」-> 點擊 -> 輸入密碼 `1111`。
    - 送出 -> 應轉導並登入。
