# SQL 修正執行指南

本指南提供在 Supabase Dashboard 執行 SQL 修正的步驟。

---

## 📋 執行順序

| 步驟 | 檔案 | 優先級 | 風險 | 說明 |
|------|------|--------|------|------|
| 1 | `fix_step1_rhr_field.sql` | 🟡 中 | 🟢 低 | 修正心率欄位名稱（Bug 修復） |
| 2 | `fix_step2_acwr_return.sql` | 🟢 低 | 🟢 極低 | 規範 RETURN 語法 |
| 3 | `fix_step3_fn_join_team_password.sql` | 🔴 嚴重 | 🟡 中 | **安全修正**：密碼加密 |
| 4 | `fix_step4_deprecate_legacy_login.sql` | 🟡 中 | 🟢 低 | 標記舊函式為 deprecated |

---

## 🚀 執行步驟

### 1. 登入 Supabase Dashboard

1. 前往 [https://supabase.com/dashboard](https://supabase.com/dashboard)
2. 選擇您的專案
3. 點選左側選單 **SQL Editor**

### 2. 執行 SQL 檔案

**對每個檔案，按以下步驟執行：**

```
Step 1: 複製整個 SQL 檔案內容
Step 2: 貼上到 SQL Editor
Step 3: 點選 "Run" 執行
Step 4: 檢查執行結果（應該會看到 ✅ 成功訊息）
Step 5: 立即測試相關功能
```

### 3. 各步驟測試方法

#### Step 1 測試（心率欄位）
- 前往 Dashboard
- 查看任一球員的疲勞狀態
- 確認 RHR 顯示正確數值

#### Step 2 測試（ACWR 計算）
- 查看球員的 ACWR 指標
- 確認數值顯示正常

#### Step 3 測試（密碼加密）⚠️ 重要
1. **先執行檢查 SQL**：
   ```sql
   SELECT 
       COUNT(*) as total,
       COUNT(CASE WHEN password_hash NOT LIKE '$2%' THEN 1 END) as plaintext
   FROM sport.players
   WHERE password_hash IS NOT NULL;
   ```
2. 若 `plaintext > 0`，**必須先執行資料遷移**（見檔案中的註解）
3. 執行修正後，測試新球員註冊功能

#### Step 4 測試（Legacy 函式）
- 確認前端登入功能正常
- （此步驟不影響現有功能）

---

## ⚠️ 安全注意事項

1. **Step 3 (密碼加密) 執行前必讀**：
   - 先檢查是否有明文密碼
   - 若有，必須先執行資料遷移
   - 測試新註冊功能確保密碼正確加密

2. **建議執行時間**：
   - 🟢 Step 1, 2, 4: 任何時間
   - 🔴 Step 3: 低峰時段（避免影響註冊用戶）

3. **回滾準備**：
   - 每個檔案都包含回滾指令（註解中）
   - 若出現問題，立即執行回滾

---

## 🆘 問題排查

### 問題：pgcrypto extension 不存在

**解決方案**：
```sql
CREATE EXTENSION IF NOT EXISTS pgcrypto SCHEMA extensions;
```

### 問題：執行失敗顯示權限錯誤

**解決方案**：
- 確認您使用的是 `service_role` 連線
- 或在 Dashboard 的 SQL Editor 中執行（自動使用最高權限）

### 問題：測試失敗找不到測試球員

**解決方案**：
- 修改 SQL 中的測試球隊 slug
- 或暫時跳過測試步驟

---

## ✅ 執行檢查清單

- [ ] Step 1: 心率欄位修正完成
- [ ] Step 2: ACWR 語法規範完成
- [ ] Step 3: 密碼加密修正完成
- [ ] Step 4: Legacy 函式標記完成
- [ ] 所有功能測試通過
- [ ] 前端登入/註冊正常運作
- [ ] Dashboard 數據顯示正確

---

## 📞 需要協助？

若執行過程中遇到問題，請保留：
1. 錯誤訊息截圖
2. 執行的 SQL 片段
3. 執行時間點

這將有助於快速診斷問題。
